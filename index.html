<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Kakao + GAS ë©”ì‹œì§€ ì‹œìŠ¤í…œ</title>
    <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
    <style>
      body { font-family: sans-serif; padding: 20px; }
      button { margin: 5px; }
      table, td, th {
        border: 1px solid #aaa;
        border-collapse: collapse;
        padding: 6px;
      }
    </style>
  </head>
  <body>
    <h1>Kakao ë©”ì‹œì§€ ì „ì†¡ ì‹œìŠ¤í…œ</h1>

    <!-- ë¡œê·¸ì¸ ë²„íŠ¼ -->
    <button onclick="kakaoLogin()">ğŸ” ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸</button>
    <div id="loginStatus"></div>

    <!-- ì¹œêµ¬ ëª©ë¡ ë¡œë“œ -->
    <button onclick="loadFriends()">ğŸ‘¥ ì¹œêµ¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <ul id="friendList"></ul>

    <!-- ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° -->
    <button onclick="loadSpreadsheet()">ğŸ“„ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <div id="messageTable"></div>

    <script>
      // Kakao SDK ì´ˆê¸°í™”
      Kakao.init('14176fbe9fd1207aa56bbef12b10080a'); // ì¹´ì¹´ì˜¤ JavaScript í‚¤ë¡œ ë³€ê²½í•˜ì„¸ìš”

      let kakaoFriends = [];
      let sheetData = [];

      function kakaoLogin() {
        Kakao.Auth.login({
          success: function(authObj) {
            document.getElementById('loginStatus').innerText = 'âœ… ë¡œê·¸ì¸ ì„±ê³µ';
          },
          fail: function(err) {
            document.getElementById('loginStatus').innerText = 'âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + JSON.stringify(err);
          }
        });
      }

      function loadFriends() {
        Kakao.API.request({
          url: '/v1/api/talk/friends',
          success: function(res) {
            kakaoFriends = res.elements;
            let html = kakaoFriends.map(f => `<li>${f.profile_nickname} (uuid: ${f.uuid})</li>`).join('');
            document.getElementById('friendList').innerHTML = html;
          },
          fail: function(error) {
            alert('ì¹œêµ¬ ëª©ë¡ ì‹¤íŒ¨: ' + JSON.stringify(error));
          }
        });
      }

      function loadSpreadsheet() {
        fetch("https://script.google.com/macros/s/AKfycbw1MTqWx5x2pq8qx0RY7u2snSYoBTX85imRbfgiP9SwLDyESh_hLEYrz-0OscU1K1Gf/exec")
          .then(res => res.json())
          .then(data => {
            sheetData = data;
            renderMessageTable();
          });
      }

      function renderMessageTable() {
        let html = "<table><tr><th>ì´ë¦„</th><th>ë©”ì‹œì§€</th><th>ìƒíƒœ</th><th>ì „ì†¡</th></tr>";
        sheetData.forEach((row, idx) => {
          const [name, msg, status] = row;
          html += `<tr><td>${name}</td><td>${msg}</td><td>${status}</td>`;
          html += `<td><button onclick="sendMessage(${idx})">ë³´ë‚´ê¸°</button></td></tr>`;
        });
        html += "</table>";
        document.getElementById('messageTable').innerHTML = html;
      }

      function sendMessage(rowIdx) {
        const [name, message] = sheetData[rowIdx];
        const friend = kakaoFriends.find(f => f.profile_nickname === name);

        if (!friend) {
          alert(`${name} ë‹˜ì„ ì¹œêµ¬ ëª©ë¡ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
          return;
        }

        // í…œí”Œë¦¿ ë©”ì‹œì§€ ì „ì†¡ ì˜ˆì‹œ (ê¶Œí•œ í•„ìš”)
        Kakao.API.request({
          url: '/v1/api/talk/friends/message/send',
          data: {
            receiver_uuids: JSON.stringify([friend.uuid]),
            template_id: ğŸ”¢12345, // í…œí”Œë¦¿ ID ì‹¤ì œ ê°’ìœ¼ë¡œ ëŒ€ì²´
            template_args: JSON.stringify({ message: message })
          },
          success: function(res) {
            alert(`âœ… ${name}ë‹˜ì—ê²Œ ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ!`);
          },
          fail: function(err) {
            alert(`âŒ ë©”ì‹œì§€ ì‹¤íŒ¨: ${JSON.stringify(err)}`);
          }
        });
      }
    </script>
  </body>
</html>
